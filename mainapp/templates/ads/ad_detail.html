{% load static %}
<!DOCTYPE html>
<html lang="{{ lang|default:'en' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ meta.title|default:ad.title }}</title>
  {% if meta.description %}<meta name="description" content="{{ meta.description }}">{% endif %}
  {% if meta.image %}<meta property="og:image" content="{{ meta.image }}">{% endif %}
  <meta property="og:title" content="{{ meta.title|default:ad.title }}">
  <meta property="og:url" content="{{ meta.url }}">

  <!-- Optional external sheet hook -->
  <link rel="stylesheet" href="{% static 'css/ad-page.css' %}">

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827; /* slate-900 */
      --muted:#6b7280; /* slate-500 */
      --line:#e5e7eb; /* gray-200 */
      --brand:#2563eb; /* blue-600 */
      --brand-weak:#e6f0ff;
      --success:#059669; /* emerald-600 */
      --danger:#dc2626; /* red-600 */
      --star:#f59e0b; /* amber-500 */
      --radius:16px;
      --shadow:0 10px 25px rgba(0,0,0,.06);
    }
    html[lang="ar"] body{direction:rtl}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Naskh Arabic","Geeza Pro",sans-serif;margin:0;background:var(--bg);color:var(--text)}
    a{color:var(--brand);text-decoration:none}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}

    /* Top header bar (breadcrumb/share) */
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:12px}
    .crumbs{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px}
    .btn-icon{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

    /* Main grid */
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    /* Left column: media + details */
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .pad{padding:16px}

    .media{display:grid;grid-template-columns:88px 1fr;gap:12px}
    @media (max-width: 640px){.media{grid-template-columns:1fr}}

    .thumbs{display:flex;flex-direction:column;gap:8px}
    .thumbs button{border:1px solid var(--line);background:#fff;border-radius:12px;overflow:hidden;padding:0;height:64px;cursor:pointer}
    .thumbs img{width:100%;height:100%;object-fit:cover;display:block}
    .viewer{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center;min-height:420px}
    .viewer img,.viewer video{max-width:100%;max-height:560px;width:100%;height:auto;display:block}

    /* Title block */
    .title-wrap{display:flex;flex-direction:column;gap:6px;margin-top:10px}
    h1.title{font-size:22px;line-height:1.3;margin:0}
    .meta{color:var(--muted);font-size:13px}
    .rating{display:flex;align-items:center;gap:8px;font-size:13px}
    .stars{color:var(--star)}

    /* Description */
    .section{margin-top:16px}
    .section h3{font-size:16px;margin:0 0 8px}
    .desc{color:#111827;line-height:1.6;font-size:15px;white-space:pre-wrap}

    /* Specs (core + dynamic) */
    .specs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .spec{background:#fafbfc;border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    .spec .label{font-size:12px;color:var(--muted);margin:0 0 4px}
    .spec .value{font-size:15px;font-weight:600;margin:0}

    /* Right column: buy box */
    .buybox{position:sticky;top:16px}
    .box{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .price{display:flex;align-items:flex-end;gap:8px}
    .price .amount{font-size:28px;font-weight:800}
    .price .unit{color:var(--muted);font-size:13px}
    .availability{margin-top:8px;color:var(--success);font-weight:600}
    .cta{display:flex;flex-direction:column;gap:10px;margin-top:14px}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px;border-radius:12px;border:1px solid transparent;font-weight:700;cursor:pointer}
    .btn.buy{background:var(--brand);color:#fff}
    .btn.outline{background:#fff;border-color:var(--line)}
    .contact{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}

    .seller{margin-top:14px;padding-top:12px;border-top:1px dashed var(--line);font-size:13px;color:var(--muted)}

    /* Inline gallery strip under title (mobile like Amazon) */
    .strip{display:flex;gap:8px;overflow:auto;padding:10px 0}
    .strip img{height:72px;width:auto;border-radius:10px;border:1px solid var(--line)}

    /* RTL tweaks */
    html[lang="ar"] .price .amount{font-weight:900}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="crumbs">
        <a href="/">{% if lang == 'ar' %}Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©{% else %}Home{% endif %}</a>
        <span>â€º</span>
        <a href="/c/{{ category.slug }}">{{ category.name }}</a>
        <span>â€º</span>
        <span>{{ ad.code }}</span>
      </div>
      <div class="actions">
        <a class="btn-icon" href="javascript:window.print()" aria-label="Print">ğŸ–¨ï¸ <span>{% if lang == 'ar' %}Ø·Ø¨Ø§Ø¹Ø©{% else %}Print{% endif %}</span></a>
        <a class="btn-icon" href="{{ meta.url }}" aria-label="Share">ğŸ”— <span>{% if lang == 'ar' %}Ù…Ø´Ø§Ø±ÙƒØ©{% else %}Share{% endif %}</span></a>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Media + Title + Description + Specs -->
      <section class="card pad">
        <!-- Media block -->
        <div class="media">
          <!-- Thumbnails (images + optional video thumb) -->
          <div class="thumbs" id="thumbs">
            {% if images %}
              {% for u in images %}
              <button type="button" data-media="img" data-src="{{ u }}">
                <img src="{{ u }}" alt="thumb {{ forloop.counter }}">
              </button>
              {% endfor %}
            {% endif %}
            {% if video %}
              <button type="button" data-media="video" data-src="{{ video }}">
                <img src="{% static 'img/video-thumb.png' %}" alt="video">
              </button>
            {% endif %}
          </div>

          <!-- Viewer -->
          <div class="viewer" id="viewer">
            {% if images and images.0 %}
              <img id="viewerImg" src="{{ images.0 }}" alt="main image">
            {% elif video %}
              <video id="viewerVideo" src="{{ video }}" controls playsinline></video>
            {% else %}
              <img id="viewerImg" src="{% static 'img/placeholder.png' %}" alt="placeholder">
            {% endif %}
          </div>
        </div>

        <!-- Title + meta + quick rating -->
        <div class="title-wrap">
          <h1 class="title">{{ ad.title|default:category.name }}</h1>
          <div class="rating">
            <div class="stars">â˜…â˜…â˜…â˜…â˜…</div>
            <div class="meta">{{ category.name }} â€¢ {% if ad.city %}{{ ad.city }} â€¢ {% endif %}{% if ad.published_at %}{{ ad.published_at|date:"Y-m-d H:i" }} â€¢ {% endif %}{{ ad.code }}</div>
          </div>
        </div>

        <!-- Inline gallery strip under the title (mobile friendly) -->
        {% if images %}
        <div class="strip">
          {% for u in images %}
            <img src="{{ u }}" alt="photo {{ forloop.counter }}">
          {% endfor %}
        </div>
        {% endif %}

        <!-- Description (if provided) -->
        {% if ad.description %}
        <div class="section">
          <h3>{% if lang == 'ar' %}Ø§Ù„ÙˆØµÙ{% else %}Description{% endif %}</h3>
          <div class="desc">{{ ad.description|linebreaksbr }}</div>
        </div>
        {% endif %}

        <!-- Specs: Core Info -->
        <div class="section">
          <h3>{% if lang == 'ar' %}Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©{% else %}Core Info{% endif %}</h3>
          <div class="specs">
            {% for f in core %}
              {% if f.value %}
              <div class="spec">
                <p class="label">{{ f.label }}</p>
                <p class="value">{{ f.value }}</p>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Specs: Dynamic fields -->
        {% if dynamic %}
        <div class="section">
          <h3>{% if lang == 'ar' %}ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©{% else %}More Details{% endif %}</h3>
          <div class="specs">
            {% for f in dynamic %}
              {% if f.value %}
              <div class="spec">
                <p class="label">{{ f.label }}</p>
                <p class="value">{{ f.value }}</p>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endif %}

      </section>

      <!-- RIGHT: Buy Box / Contact -->
      <aside class="buybox">
        <div class="box pad">
          <div class="price">
            <div class="amount">
              {% if ad.price %}{{ ad.price }}{% else %}
                {% for f in core %}{% if f.label|lower == 'price' or f.label|lower == 'Ø§Ù„Ø³Ø¹Ø±' %}{{ f.value }}{% endif %}{% endfor %}
              {% endif %}
            </div>
            {% if ad.currency %}<div class="unit">{{ ad.currency }}</div>{% endif %}
          </div>
          <div class="availability">{% if ad.is_available %}{% if lang == 'ar' %}Ù…ØªÙˆÙØ±{% else %}In stock{% endif %}{% else %}{% if lang == 'ar' %}ØºÙŠØ± Ù…ØªÙˆÙØ±{% else %}Out of stock{% endif %}{% endif %}</div>

          <div class="cta">
            <button class="btn buy" id="buyBtn">{% if lang == 'ar' %}Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†{% else %}Buy Now{% endif %}</button>
            <button class="btn outline" id="addCart">{% if lang == 'ar' %}Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©{% else %}Add to Cart{% endif %}</button>
            <div class="contact">
              {% if ad.phone %}
                <a class="btn outline" href="tel:{{ ad.phone }}">ğŸ“ {% if lang == 'ar' %}Ø§ØªØµØ§Ù„{% else %}Call{% endif %}</a>
              {% endif %}
              {% if ad.whatsapp %}
                <a class="btn outline" href="https://wa.me/{{ ad.whatsapp }}" target="_blank" rel="noopener">ğŸ’¬ WhatsApp</a>
              {% endif %}
            </div>
          </div>

          <div class="seller">
            <div><strong>{% if lang == 'ar' %}Ø§Ù„Ø¨Ø§Ø¦Ø¹{% else %}Seller{% endif %}:</strong> {{ ad.seller_name|default:"â€”" }}</div>
            <div><strong>{% if lang == 'ar' %}ÙŠØ´Ø­Ù† Ù…Ù†{% else %}Ships from{% endif %}:</strong> {{ ad.city|default:"â€”" }}</div>
            <div><strong>{% if lang == 'ar' %}Ø±Ù…Ø² Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†{% else %}Ad Code{% endif %}:</strong> {{ ad.code }}</div>
          </div>
        </div>

        <!-- Safety tips card -->
        <div class="box pad" style="margin-top:12px">
          <h3 style="margin:0 0 8px;font-size:15px">{% if lang == 'ar' %}Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø£Ù…Ø§Ù†{% else %}Safety Tips{% endif %}</h3>
          <ul style="margin:0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.6">
            <li>{% if lang == 'ar' %}Ù‚Ø§Ø¨Ù„ ÙÙŠ Ù…ÙƒØ§Ù† Ø¹Ø§Ù…{% else %}Meet in public places.{% endif %}</li>
            <li>{% if lang == 'ar' %}Ø§ÙØ­Øµ Ø§Ù„Ù…Ù†ØªØ¬ Ø¬ÙŠØ¯Ù‹Ø§{% else %}Inspect items carefully.{% endif %}</li>
            <li>{% if lang == 'ar' %}ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©{% else %}Avoid upfront transfers.{% endif %}</li>
          </ul>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // Simple gallery switcher (no dependencies)
    (function(){
      var thumbs = document.getElementById('thumbs');
      var viewer = document.getElementById('viewer');
      if(!thumbs || !viewer) return;

      function showImage(src){
        viewer.innerHTML = '';
        var img = document.createElement('img');
        img.id = 'viewerImg';
        img.src = src; img.alt = 'image';
        viewer.appendChild(img);
      }
      function showVideo(src){
        viewer.innerHTML = '';
        var v = document.createElement('video');
        v.id = 'viewerVideo'; v.src = src; v.controls = true; v.playsInline = true;
        viewer.appendChild(v);
      }
      thumbs.addEventListener('click', function(e){
        var btn = e.target.closest('button');
        if(!btn) return;
        var kind = btn.getAttribute('data-media');
        var src = btn.getAttribute('data-src');
        if(kind === 'video') showVideo(src); else showImage(src);
      });
    })();
  </script>
</body>
</html>
