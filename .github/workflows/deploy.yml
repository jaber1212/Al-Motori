name: Deploy to VPS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Write SSH private key from GitHub Secret
      - name: Write private key
        run: |
          mkdir -p ~/.ssh
          umask 077
          cat > ~/.ssh/ci_key << 'EOF'
          ${{ secrets.SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/ci_key

      # 3) Add VPS Host to known_hosts
      - name: Add host to known_hosts
        run: |
          ssh-keyscan -T 15 -p "${{ secrets.PORT }}" "${{ secrets.HOST }}" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      # 4) Test SSH connection
      - name: Test SSH
        run: |
          ssh -i ~/.ssh/ci_key -p "${{ secrets.PORT }}" \
            -o StrictHostKeyChecking=yes \
            "${{ secrets.USER }}@${{ secrets.HOST }}" "echo SSH OK && hostname"

      # 5) Upload project files using rsync
      - name: Upload project via rsync
        run: |
          rsync -avz --delete \
            --exclude="staticfiles" \
            --exclude="media" \
            --exclude="venv" \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="__pycache__" \
            --exclude="*.pyc" \
            --exclude=".idea" \
            -e "ssh -i ~/.ssh/ci_key -p ${{ secrets.PORT }}" \
            ./ \
            "${{ secrets.USER }}@${{ secrets.HOST }}:/home/aimotoria/htdocs/www.aimotoria.com/"


        # 6) Run deployment commands on server
      - name: Deploy (Django + Gunicorn + Nginx)
        run: |
          ssh -T -i ~/.ssh/ci_key -p "${{ secrets.PORT }}" "${{ secrets.USER }}@${{ secrets.HOST }}" << 'EOF'
          
          set -e

          PROJECT="/home/aimotoria/htdocs/www.aimotoria.com"
          cd "$PROJECT"

          echo ">>> Activating virtual environment"
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate

          echo ">>> Installing dependencies"
          pip install --upgrade pip
          [ -f requirements.txt ] && pip install -r requirements.txt || true

          echo ">>> Running migrations"
          python manage.py migrate --noinput

          echo ">>> Running seeders"
          python manage.py seed_field_types || true
          python manage.py seed_cars_schema || true
          python manage.py seed_cars_fields || true
          python manage.py seed_admin_role || true
          python manage.py qr_batch_generate || true
          python manage.py fetch_real_cars

          echo ">>> Collect static"
          python manage.py collectstatic --noinput

          echo ">>> Restarting Services"
          sudo systemctl restart gunicorn-www.aimotoria.com
          sudo systemctl restart nginx

          echo ">>> Deployment completed successfully!"
          EOF
